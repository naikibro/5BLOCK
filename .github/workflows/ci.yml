name: CI Pipeline

on:
  push:
    branches: [main, develop, epic/**]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Compilation Solidity
  compile-solidity:
    name: ğŸ”¨ Compile Solidity
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: ğŸ“¦ Install deps
        run: npm ci
      
      - name: ğŸ”¨ Compile
        run: npm run compile

  # Job 2: Tests Smart Contracts
  test-contracts:
    name: ğŸ§ª Test Contracts
    runs-on: ubuntu-latest
    needs: compile-solidity
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: ğŸ“¦ Install deps
        run: npm ci
      
      - name: ğŸ§ª Run tests
        run: npm run test

  # Job 3: Compilation TypeScript (Frontend)
  compile-frontend:
    name: ğŸ”¨ Compile Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: ğŸ“¦ Install deps
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ”¨ Build
        run: pnpm build
        env:
          NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID || 'dummy-for-ci' }}
          NEXT_PUBLIC_CONTRACT_ADDRESS: '0x0000000000000000000000000000000000000000'

  # Job 4: Lint Frontend
  lint-frontend:
    name: ğŸ” Lint Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: ğŸ“¦ Install deps
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ” Lint
        run: pnpm lint

  # Job 5: Tests Frontend
  test-frontend:
    name: ğŸ§ª Test Frontend
    runs-on: ubuntu-latest
    needs: compile-frontend
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: ğŸ“¦ Install deps
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ§ª Run tests
        run: CI=true pnpm test

  # Job 6: Summary
  ci-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [compile-solidity, test-contracts, compile-frontend, lint-frontend, test-frontend]
    if: always()
    
    steps:
      - name: ğŸ“Š Check results
        run: |
          echo "ğŸ‰ CI Pipeline completed!"
          echo ""
          echo "âœ… Solidity compilation: ${{ needs.compile-solidity.result }}"
          echo "âœ… Contract tests: ${{ needs.test-contracts.result }}"
          echo "âœ… Frontend compilation: ${{ needs.compile-frontend.result }}"
          echo "âœ… Frontend linting: ${{ needs.lint-frontend.result }}"
          echo "âœ… Frontend tests: ${{ needs.test-frontend.result }}"
      
      - name: âŒ Fail if any job failed
        if: |
          needs.compile-solidity.result == 'failure' ||
          needs.test-contracts.result == 'failure' ||
          needs.compile-frontend.result == 'failure' ||
          needs.lint-frontend.result == 'failure' ||
          needs.test-frontend.result == 'failure'
        run: |
          echo "âŒ One or more CI jobs failed"
          exit 1
